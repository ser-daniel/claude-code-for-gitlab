# GitLab CI/CD Configuration for Claude Code
# For use with git.agenticlab.tech self-hosted GitLab instance
# This configuration routes Claude API traffic through xray proxy (172.17.0.1:801)

variables:
  # Claude configuration
  CLAUDE_TRIGGER_PHRASE: "@claude"
  CLAUDE_MODEL: "opus"

  # Branch configuration
  CLAUDE_BRANCH_PREFIX: "claude/"
  BASE_BRANCH: "main"

  # Git configuration
  GIT_STRATEGY: clone
  GIT_DEPTH: 0

# Claude Code job - triggered on MR comments mentioning @claude
claude_assistant:
  image: oven/bun:1.1.29-alpine
  stage: build

  # Use the dedicated Claude runner (proxy configured per-job)
  tags:
    - claude-code

  before_script:
    # Install dependencies
    - apk add --no-cache git openssh-client ca-certificates curl nodejs npm

    # Configure git
    - git config --global user.name "Claude Assistant"
    - git config --global user.email "claude@agenticlab.tech"

    # Clone Claude Code for GitLab (using your fork)
    - git clone https://github.com/ser-daniel/claude-code-for-gitlab.git /tmp/claude-code
    - cd /tmp/claude-code
    - bun install --frozen-lockfile

    # Return to project directory
    - cd $CI_PROJECT_DIR

  script:
    # Debug: Check webhook variables
    - echo "=== Webhook Variables Debug ==="
    - echo "CLAUDE_TRIGGER=${CLAUDE_TRIGGER:-not set}"
    - echo "DIRECT_PROMPT=${DIRECT_PROMPT:-not set}"
    - echo "CLAUDE_NOTE=${CLAUDE_NOTE:-not set}"
    - echo "GITLAB_WEBHOOK_PAYLOAD length=${#GITLAB_WEBHOOK_PAYLOAD}"
    - echo "==============================="

    # Step 1: Run prepare script (WITHOUT proxy to avoid undici issues)
    - echo "Step 1 - Preparing Claude Code action..."
    - cd /tmp/claude-code && bun run src/entrypoints/prepare.ts

    # Check if trigger was found (prompt file created)
    - |
      if [ ! -f "/tmp/claude-prompts/claude-prompt.txt" ]; then
        echo "No @claude trigger found - skipping Claude execution"
        exit 0
      fi

    # Step 2: Install Claude Code globally
    - echo "Step 2 - Installing Claude Code..."
    - bun install -g @anthropic-ai/claude-code@1.0.60

    # Step 3: Install base-action dependencies
    - echo "Step 3 - Installing base-action dependencies..."
    - cd /tmp/claude-code/base-action && bun install && cd /tmp/claude-code

    # Step 4: Run Claude Code via base-action (WITH proxy for Anthropic API)
    - echo "Step 4 - Running Claude Code with proxy..."
    - |
      export HTTP_PROXY=http://172.17.0.1:801
      export HTTPS_PROXY=http://172.17.0.1:801
      export http_proxy=http://172.17.0.1:801
      export https_proxy=http://172.17.0.1:801
      export NO_PROXY=gitlab,localhost,127.0.0.1,172.17.0.0/16,git.agenticlab.tech
      export no_proxy=gitlab,localhost,127.0.0.1,172.17.0.0/16,git.agenticlab.tech

      # Set up environment for base-action
      export CLAUDE_CODE_ACTION="1"
      export INPUT_PROMPT_FILE="/tmp/claude-prompts/claude-prompt.txt"
      export INPUT_TIMEOUT_MINUTES="30"
      export INPUT_MCP_CONFIG=""
      export INPUT_SETTINGS=""
      export INPUT_SYSTEM_PROMPT=""
      export INPUT_APPEND_SYSTEM_PROMPT=""
      export INPUT_ALLOWED_TOOLS="${ALLOWED_TOOLS:-}"
      export INPUT_DISALLOWED_TOOLS="${DISALLOWED_TOOLS:-}"
      export INPUT_MAX_TURNS="${MAX_TURNS:-}"
      export INPUT_CLAUDE_ENV="${CLAUDE_ENV:-}"
      export INPUT_FALLBACK_MODEL="${FALLBACK_MODEL:-}"
      export ANTHROPIC_MODEL="${CLAUDE_MODEL:-opus}"
      export DETAILED_PERMISSION_MESSAGES="1"

      # Run the base-action (this is where Anthropic API is called)
      cd /tmp/claude-code && bun run base-action/src/index.ts

    # Step 5: Update comment with results (if applicable)
    - |
      if [ -n "$CLAUDE_COMMENT_ID" ] || [ -f "/tmp/claude-comment-id.txt" ]; then
        echo "Step 5 - Updating GitLab comment with results..."
        cd /tmp/claude-code && bun run src/entrypoints/update-comment-gitlab.ts || echo "Failed to update comment"
      else
        echo "Step 5 - No comment ID found, skipping update"
      fi

  rules:
    # Trigger via webhook when @claude is mentioned (highest priority)
    - if: '$CLAUDE_TRIGGER == "true"'
      when: always
    # Trigger on MR events (new MR, comments, etc.) - but skip if no trigger
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always

  variables:
    # GitLab server URL
    CI_SERVER_URL: "https://git.agenticlab.tech"

    # GitLab authentication (for GitLab API access)
    CLAUDE_CODE_GL_ACCESS_TOKEN: $CLAUDE_CODE_GL_ACCESS_TOKEN

    # Claude authentication (for Anthropic API access)
    CLAUDE_CODE_OAUTH_TOKEN: $CLAUDE_CODE_OAUTH_TOKEN

    # Note: Webhook variables (GITLAB_WEBHOOK_PAYLOAD, DIRECT_PROMPT, CLAUDE_NOTE, etc.)
    # are automatically passed through from the webhook trigger and don't need to be declared here

  # Required CI/CD Variables (Settings → CI/CD → Variables):
  # 1. CLAUDE_CODE_GL_ACCESS_TOKEN: GitLab Personal Access Token
  #    - Scopes: api, read_repository, write_repository
  #    - You have: glpat-Ykn9BATOykcTLu6IDLpJ1m86MQp1OjMH.01.0w1pbijb5
  # 2. CLAUDE_CODE_OAUTH_TOKEN: Claude Code OAuth token or ANTHROPIC_API_KEY
  #    - Get from: https://claude.ai/settings
  # Important: Do NOT mark as "Protected" or they won't work on MR pipelines!

# Alternative: Issue comment handler (for creating branches from issues)
claude_issue_handler:
  image: oven/bun:1.1.29-alpine
  stage: build

  tags:
    - claude-code

  before_script:
    - apk add --no-cache git openssh-client ca-certificates
    - git config --global user.name "Claude Assistant"
    - git config --global user.email "claude@agenticlab.tech"
    - git clone https://github.com/RealMikeChong/claude-code-for-gitlab.git /tmp/claude-code
    - cd /tmp/claude-code && bun install --frozen-lockfile
    - cd $CI_PROJECT_DIR

  script:
    - cd /tmp/claude-code && bun run src/entrypoints/prepare.ts

  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger" && $TRIGGER_TYPE == "issue_comment"'
      when: always

  variables:
    CLAUDE_CODE_OAUTH_TOKEN: $CLAUDE_CODE_OAUTH_TOKEN
    CLAUDE_BRANCH: "${CLAUDE_BRANCH_PREFIX}issue-${CI_ISSUE_IID}"
    CI_SERVER_URL: "https://git.agenticlab.tech"
